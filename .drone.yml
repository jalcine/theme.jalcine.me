---
kind: pipeline
name: website

pipeline:
  git_push:
    image: appleboy/drone-git-push
    remote: dokku@jacky.wtf:jacky-wtf-static
    branch: master
    local_ref: HEAD

clone:
  depth: 1

steps:
  - name: build - frontend
    image: node:9.8.0-alpine
    volumes:
      - name: npm
        path: /drone/src/node_modules
    commands:
      - npm config set loglevel warn
      - npm install
  - name: build - jekyll deps
    image: ruby:2.5.0-alpine
    volumes:
      - name: npm
        path: /drone/src/node_modules
      - name: ruby
        path: /drone/src/vendor/bundle
    commands:
      - apk add -U build-base
      - bundle install --deployment
  - name: build - website
    image: ruby:2.5.0-alpine
    volumes:
      - name: npm
        path: /drone/src/node_modules
      - name: ruby
        path: /drone/src/vendor/bundle
    environment:
      ENV: 'test'
    commands:
      - bundle exec rake build:deploy
      - bundle exec rake spec
  - name: deploy
    image: ruby:2.5.0-alpine
    environment:
      DOKKU_SSH_KEY:
        from_secret: drone_ssh_key
    commands:
      - echo "${DRONE_SSH_KEY}" | tee ~/.ssh/id_rsa
      - git remote add dokku dokku@jacky.wtf:jacky-wtf-static
      - git push dokku HEAD:master
